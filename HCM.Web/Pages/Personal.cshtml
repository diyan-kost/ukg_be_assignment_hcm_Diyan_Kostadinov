@page "{id:int}"

@using HCM.Core.Models.Employee;

@model PersonalModel

@{
    var details = Model.EmployeeDetails;
}

<h1>Personal Details</h1>
<br />
@if (Model != null && details != null)
{
    <div>
        <h4 class="mb-3">Billing address</h4>
        <form asp-page-handler="UpdateEmployee" class="needs-validation" method="post" novalidate>
            <div class="row g-3">

                <div class="col-sm-4">
                    <label for="firstName" class="form-label">First name</label>
                    <input asp-for="UpdateEmployeeModel.FirstName" type="text" class="form-control" id="firstName" placeholder="" value="@details.FirstName" required>
                    <div class="invalid-feedback">
                        Valid first name is required.
                    </div>
                </div>

                <div class="col-sm-4">
                    <label for="middleName" class="form-label">Middle name <span class="text-body-secondary">(Optional)</span></label>
                    <input asp-for="UpdateEmployeeModel.MiddleName" type="text" class="form-control" id="middleName" placeholder="" value="@details.MiddleName">
                    <div class="invalid-feedback">
                        Valid middle name is required.
                    </div>
                </div>

                <div class="col-sm-4">
                    <label for="lastName" class="form-label">Last name <span class="text-body-secondary">(Optional)</span></label>
                    <input asp-for="UpdateEmployeeModel.LastName" type="text" class="form-control" id="lastName" placeholder="" value="@details.LastName">
                    <div class="invalid-feedback">
                        Valid last name is required.
                    </div>
                </div>  

                <div class="col-12">
                    <label for="email" class="form-label">Email</label>
                    @if (User.IsInRole("HR Admin"))
                    {
                        <input asp-for="UpdateEmployeeModel.Email" type="email" class="form-control" id="email" placeholder="you@example.com" value="@details.Email" required>
                    }
                    else
                    {
                        <input asp-for="UpdateEmployeeModel.Email" type="email" class="form-control" id="email" placeholder="you@example.com" value="@details.Email" required readonly>
                    }
                    <div class="invalid-feedback">
                        Please enter a valid email address.
                    </div>
                </div>

                <div class="col-12">
                    <label for="phoneNumber" class="form-label">Phone Number</label>
                    <input asp-for="UpdateEmployeeModel.PhoneNumber" type="text" class="form-control" id="phoneNumber" placeholder="+359555555555" value="@details.PhoneNumber" required>
                    <div class="invalid-feedback">
                        Please enter a valid phone number.
                    </div>
                </div>

                <div class="col-12">
                    <label for="address" class="form-label">Address</label>
                    <input asp-for="UpdateEmployeeModel.Address" type="text" class="form-control" id="address" placeholder="1234 Main St" value="@details.CurrentAddress" required>
                    <div class="invalid-feedback">
                        Please enter your current address.
                    </div>
                </div>

                <div class="col-12">
                    <label for="managerName" class="form-label">Manager</label>
                    <input type="text" class="form-control" id="managerName" placeholder="Ivan Ivanov" value="@details.ManagerName" readonly>
                </div>

                <div class="col-4">
                    <label for="nationalId" class="form-label">National ID</label>
                    @if (User.IsInRole("HR Admin"))
                    {
                        <input asp-for="UpdateEmployeeModel.NationalIdNumber" type="text" class="form-control" id="nationalId" placeholder="9000000000" value="@details.NationalIdNumber">
                    }
                    else
                    {
                        <input asp-for="UpdateEmployeeModel.NationalIdNumber" type="text" class="form-control" id="nationalId" placeholder="9000000000" value="@details.NationalIdNumber" readonly>
                    }
                </div>

                <div class="col-4">
                    <label for="gender" class="form-label">Gender</label>
                    <input type="text" class="form-control" id="gender" placeholder="Gender" value="@details.Gender" readonly>
                </div>

                <div class="col-4">
                    <label for="hiredAt" class="form-label">Hired At</label>
                    <input type="text" class="form-control" id="hiredAt" placeholder="2025-01-01" value="@details.HiredAt.ToString("D")" readonly>
                </div>

            </div>

            <hr class="my-4"> 

            <button class="w-100 btn btn-primary btn-lg" type="submit">Save Changes</button>

            <input asp-for="UpdateEmployeeModel.ManagerId" type="text" value="@details.ManagerId" style="display:none;" readonly/>
            <input asp-for="UpdateEmployeeModel.Id" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly/>
        </form>

        <hr class="my-4"> 

       
            @if (User.IsInRole("HR Admin"))
            {
                if(details.Username == null)
                {
                    <form method="post" asp-page-handler="CreateUser">
                        <div class="col-6">
                            <label for="username" class="form-label">Username</label>
                            <div class="input-group has-validation">
                                <input asp-for="CreateUser.Username" type="text" class="form-control" id="username" placeholder="Username" value="" required>
                                <div class="invalid-feedback">
                                    Username is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-6">
                            <label for="password" class="form-label">New Password</label>
                            <div class="input-group has-validation">
                                <input asp-for="CreateUser.Password" type="password" class="form-control" id="password" placeholder="***" value="">
                                <div class="invalid-feedback">
                                    Password is required.
                                </div>
                            </div>
                        </div>

                        <div class="col-md-5">
                            <label for="role" class="form-label">Role</label>
                            <select asp-for="CreateUser.Role" class="form-select" id="role" required>
                                <option value="Employee" selected>Employee</option>
                                <option value="Manager">Manager</option>
                                <option value="HR Admin">HR Admin</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a valid role.
                            </div>
                        </div>

                        <button class="w-100 btn btn-primary btn-lg" type="submit">Create User</button>
                        
                        <input asp-for="CreateUser.EmployeeId" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly />
                    </form>

                    

                }
                else
                {
                    <div class="col-6">
                        <label for="username" class="form-label">Username</label>
                        <div class="input-group has-validation">
                            <input type="text" class="form-control" id="username" placeholder="Username" value="@details.Username" required readonly>
                            <div class="invalid-feedback">
                                Username is required.
                            </div>
                        </div>
                    </div>

                    <br />

                    <div>

                        <form method="post" asp-page-handler="UpdateUser">

                        <div class="col-md-5">
                            <label for="role" class="form-label">Role</label>
                            <select asp-for="UpdateUser.Role" class="form-select" id="role" required>
                                <option value="" selected>Keep current role</option>
                                <option value="Employee">Employee</option>
                                <option value="Manager">Manager</option>
                                <option value="HR Admin">HR Admin</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a valid role.
                            </div>
                        </div>

                            <button class="w-100 btn btn-primary btn-lg col-3" type="submit">Update User</button>
                            <input asp-for="UpdateUser.Username" type="text" value="@details.Username" style="display:none;" readonly />
                            <input asp-for="UpdateUser.EmployeeId" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly />
                        </form>
                    </div>

                    <br />
                    <div>
                        <form method="post" asp-page-handler="DeleteUser">

                            <button class="w-100 btn btn-primary btn-lg col-3" type="submit">Delete User</button>
                            <input asp-for="DeleteUser.Username" type="text" value="@details.Username" style="display:none;" readonly />
                            <input asp-for="DeleteUser.EmployeeId" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly />
                        </form>
                    </div>

                }
                
            }
            else if (User.IsInRole("Employee"))
            {
                <form method="post" asp-page-handler="UpdateUser">
                    <div class="col-6">
                        <label for="username" class="form-label">Username</label>
                        <div class="input-group has-validation">
                            <input asp-for="UpdateUser.Username" type="text" class="form-control" id="username" placeholder="Username" value="@details.Username" required readonly>
                            <div class="invalid-feedback">
                                Username is required.
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <label for="password" class="form-label">New Password</label>
                        <div class="input-group has-validation">
                            <input  asp-for="UpdateUser.Password" type="password" class="form-control" id="password" placeholder="***" value="" >
                            <div class="invalid-feedback">
                                Password is required.
                            </div>
                        </div>
                    </div>
                    
                    <br />

                <button class="w-100 btn btn-primary btn-lg" type="submit">Update password</button>
                <input asp-for="UpdateUser.EmployeeId" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly />

                </form>
            }
            else
            {
                <div class="col-6">
                    <label for="username" class="form-label">Username</label>
                    <div class="input-group has-validation">
                        <input type="text" class="form-control" id="username" placeholder="Username" value="@(details.Username ?? "N/A")" required readonly>
                        <div class="invalid-feedback">
                            Username is required.
                        </div>
                    </div>
                </div>
            }

        <br />

        @if (User.IsInRole("HR Admin"))
        {
            
            <form method="post" asp-page-handler="AddSalary">
                <table class="table" id="salariesTable">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Salary</th>
                            <th scope="col">Effective Date</th>
                            <th scope="col">Note</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < details.Salaries.Count; i++)
                        {
                            <tr class="@(i == 0 ? "table-active" : "")">
                                <th scope="row">@(i + 1)</th>
                                <td>@details.Salaries[i].Amount</td>
                                <td>@details.Salaries[i].EffectiveDate</td>
                                <td>@details.Salaries[i].Note</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="col-4">
                    <label for="salaryAmount" class="form-label">New Salary</label>
                    <input asp-for="AddSalaryModel.Amount" type="number" min="0" step="0.01" class="form-control" id="salaryAmount" placeholder="1234" value="">
                </div>

                <div class="col-4">
                    <label for="effectiveDate" class="form-label">Effective Date</label>
                    <input asp-for="AddSalaryModel.EffectiveDate" type="date" class="form-control" id="effectiveDate" value="">
                </div>

                <div class="col-12">
                    <label for="note" class="form-label">Note <span class="text-body-secondary">(Optional)</span></label>
                    <input asp-for="AddSalaryModel.Note" type="text" class="form-control" id="note" value="">
                </div>

                <input asp-for="AddSalaryModel.EmployeeId" type="text" value="@ViewContext.RouteData.Values["id"]" style="display:none;" readonly />

                <hr class="my-4">

                <button class="w-100 btn btn-primary btn-lg" type="submit">Update Salary</button>
            </form>
        }

    </div>
}

